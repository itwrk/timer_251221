<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>タスク編集 - ライフリッスンタイマー</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* 編集画面専用スタイル */
    .edit-container { max-width: 900px; margin: 0 auto; }
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .back-link { color: #3498db; text-decoration: none; font-weight: bold; font-size: 16px; }
    
    .task-edit-card { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 30px; overflow: hidden; }
    .task-edit-header { background: #f8f9fa; padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    
    .task-title-group { display: flex; align-items: center; gap: 10px; flex: 1; }
    .task-icon-display { font-size: 24px; color: #3498db; cursor: pointer; width: 40px; text-align: center; }
    .task-name-edit { font-size: 18px; font-weight: bold; border: 1px solid #ddd; padding: 5px 10px; border-radius: 4px; width: 200px; }
    
    .task-actions { display: flex; gap: 10px; }
    
    .step-list { padding: 0; }
    .step-item { display: flex; padding: 15px; border-bottom: 1px solid #eee; gap: 10px; align-items: flex-start; flex-wrap: wrap; }
    .step-item:nth-child(even) { background: #fafafa; }
    
    .step-col { display: flex; flex-direction: column; gap: 5px; }
    .step-col.main { flex: 2; min-width: 200px; }
    .step-col.time { flex: 1; min-width: 120px; }
    
    .step-label { font-size: 12px; color: #777; font-weight: bold; }
    .step-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    
    .time-buttons { display: flex; gap: 5px; margin-top: 5px; }
    .tb-btn { padding: 4px 8px; font-size: 11px; background: #e9ecef; border-radius: 3px; border: none; cursor: pointer; }
    .tb-btn:hover { background: #dbe2e8; }
    
    .step-delete { align-self: center; }
    
    .add-step-btn-area { padding: 15px; text-align: center; background: #fff; }
    
    /* モーダル上書き調整 */
    .modal { z-index: 9999; }
  </style>
</head>
<body>
  
  <div id="iconModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2>アイコンを選択</h2>
      <div class="icon-grid" id="presetIconGrid"></div>
    </div>
  </div>

  <div class="container edit-container">
    <div class="page-header">
      <h1><i class="fas fa-edit"></i> タスク編集</h1>
      <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> タイマーに戻る</a>
    </div>

    <div id="taskListContainer">
      </div>
    
    <div style="text-align: center; margin-top: 40px; margin-bottom: 40px;">
        <a href="index.html" class="action-btn" style="text-decoration: none; display: inline-block; width: 200px; text-align: center;">完了して戻る</a>
    </div>
  </div>

  <script>
    // --- 共有設定 (script.jsと同じ) ---
    const STORAGE_KEYS = {
      ALL_TASKS: 'lifelisten_timer_all_tasks',
      LAST_CSV: 'lifelisten_timer_last_csv'
    };
    
    const PRESET_ICONS = [
      'fa-solid fa-bath', 'fa-solid fa-toilet', 'fa-solid fa-bed', 'fa-solid fa-utensils',
      'fa-solid fa-fire-burner', 'fa-solid fa-broom', 'fa-solid fa-briefcase', 'fa-solid fa-droplet',
      'fa-solid fa-face-smile', 'fa-solid fa-sun', 'fa-solid fa-person-running', 'fa-solid fa-person-walking',
      'fa-solid fa-bicycle', 'fa-solid fa-train', 'fa-solid fa-shirt', 'fa-solid fa-tooth',
      'fa-solid fa-book', 'fa-solid fa-laptop', 'fa-solid fa-mobile-screen', 'fa-solid fa-cart-shopping',
      'fa-solid fa-yen-sign', 'fa-solid fa-mug-hot', 'fa-solid fa-wine-glass', 'fa-solid fa-music',
      'fa-solid fa-trash-can', 'fa-solid fa-pills', 'fa-solid fa-hospital', 'fa-solid fa-heart',
      'fa-solid fa-star', 'fa-solid fa-headphones'
    ];

    let allTasks = [];
    let currentEditingTaskName = null; // アイコン変更用

    // --- データ操作 ---
    function loadTasks() {
      const data = localStorage.getItem(STORAGE_KEYS.ALL_TASKS);
      if (data) {
        allTasks = JSON.parse(data);
        renderAll();
      }
    }

    function saveTasks() {
      localStorage.setItem(STORAGE_KEYS.ALL_TASKS, JSON.stringify(allTasks));
      // CSVも更新しておく
      const headers = ['タスク名', '項目名', '読み上げテキスト', '秒数', '順番', 'アイコン', 'メモ'];
      let csv = headers.join(',') + '\n';
      allTasks.forEach(t => {
        const row = headers.map(h => {
          let v = t[h] || '';
          if (typeof v === 'string') v = `"${v.replace(/"/g, '""')}"`;
          return v;
        });
        csv += row.join(',') + '\n';
      });
      localStorage.setItem(STORAGE_KEYS.LAST_CSV, csv);
    }

    // --- 描画 ---
    function renderAll() {
      const container = document.getElementById('taskListContainer');
      container.innerHTML = '';
      
      // タスク名でグループ化
      const taskGroups = {};
      const taskNames = []; // 順序保持用
      
      allTasks.forEach(task => {
        const name = task['タスク名'];
        if (!taskGroups[name]) {
          taskGroups[name] = [];
          taskNames.push(name);
        }
        taskGroups[name].push(task);
      });

      taskNames.forEach(name => {
        const tasks = taskGroups[name];
        // 順番でソート
        tasks.sort((a, b) => (a['順番'] || 0) - (b['順番'] || 0));
        
        // 親タスクのアイコン（最初のステップのものを使用）
        const iconClass = tasks[0]['アイコン'] || 'fa-solid fa-headphones';

        const card = document.createElement('div');
        card.className = 'task-edit-card';
        
        // ヘッダー
        card.innerHTML = `
          <div class="task-edit-header">
            <div class="task-title-group">
              <div class="task-icon-display" onclick="openIconModalForTask('${name}')">
                <i class="${iconClass}"></i>
              </div>
              <input type="text" class="task-name-edit" value="${name}" onchange="changeTaskName('${name}', this.value)">
            </div>
            <div class="task-actions">
              <button class="delete-btn" onclick="deleteTaskGroup('${name}')">タスクごと削除</button>
            </div>
          </div>
          <div class="step-list" id="steps-${name}"></div>
          <div class="add-step-btn-area">
            <button class="action-btn" style="width: auto;" onclick="addStepToTask('${name}')"><i class="fas fa-plus"></i> ステップを追加</button>
          </div>
        `;
        
        const listContainer = card.querySelector(`#steps-${name}`);
        
        tasks.forEach((task, idx) => {
          const item = document.createElement('div');
          item.className = 'step-item';
          
          item.innerHTML = `
            <div class="step-col main">
              <span class="step-label">項目名</span>
              <input type="text" class="step-input" value="${task['項目名'] || ''}" onchange="updateStepValue('${name}', ${idx}, '項目名', this.value)">
              <span class="step-label" style="margin-top:5px;">読み上げ</span>
              <input type="text" class="step-input" value="${task['読み上げテキスト'] || ''}" onchange="updateStepValue('${name}', ${idx}, '読み上げテキスト', this.value)">
              <span class="step-label" style="margin-top:5px;">メモ</span>
              <input type="text" class="step-input" value="${task['メモ'] || ''}" placeholder="メモを入力" onchange="updateStepValue('${name}', ${idx}, 'メモ', this.value)">
            </div>
            
            <div class="step-col time">
              <span class="step-label">秒数</span>
              <input type="number" class="step-input" id="time-${name}-${idx}" value="${task['秒数'] || 30}" onchange="updateStepValue('${name}', ${idx}, '秒数', this.value)">
              <div class="time-buttons">
                <button class="tb-btn" onclick="setStepTime('${name}', ${idx}, 30)">30s</button>
                <button class="tb-btn" onclick="setStepTime('${name}', ${idx}, 60)">1m</button>
                <button class="tb-btn" onclick="setStepTime('${name}', ${idx}, 180)">3m</button>
              </div>
            </div>
            
            <div class="step-delete">
              <button class="delete-btn" onclick="deleteStep('${name}', ${idx})"><i class="fas fa-trash"></i></button>
            </div>
          `;
          listContainer.appendChild(item);
        });
        
        container.appendChild(card);
      });
    }

    // --- 各種操作 ---
    function updateStepValue(taskName, index, field, value) {
      // 該当タスクグループを抽出
      const tasks = allTasks.filter(t => t['タスク名'] === taskName).sort((a,b)=>(a['順番']||0)-(b['順番']||0));
      const targetTask = tasks[index];
      
      // allTasks内の参照を更新
      if (field === '秒数') value = parseInt(value);
      targetTask[field] = value;
      saveTasks();
    }

    function setStepTime(taskName, index, seconds) {
      document.getElementById(`time-${taskName}-${index}`).value = seconds;
      updateStepValue(taskName, index, '秒数', seconds);
    }

    function changeTaskName(oldName, newName) {
      if (!newName) return;
      allTasks.forEach(t => {
        if (t['タスク名'] === oldName) t['タスク名'] = newName;
      });
      saveTasks();
      renderAll();
    }

    function addStepToTask(taskName) {
      // そのタスクの最後の順番を取得
      const tasks = allTasks.filter(t => t['タスク名'] === taskName);
      const maxOrder = Math.max(...tasks.map(t => t['順番'] || 0));
      const parentIcon = tasks[0]['アイコン'] || '';
      
      allTasks.push({
        'タスク名': taskName,
        '項目名': '新規ステップ',
        '読み上げテキスト': '新規ステップです',
        '秒数': 30,
        '順番': maxOrder + 1,
        'アイコン': parentIcon,
        'メモ': ''
      });
      saveTasks();
      renderAll();
    }

    function deleteStep(taskName, index) {
      if (!confirm('このステップを削除しますか？')) return;
      const tasks = allTasks.filter(t => t['タスク名'] === taskName).sort((a,b)=>(a['順番']||0)-(b['順番']||0));
      const targetTask = tasks[index];
      
      const idx = allTasks.indexOf(targetTask);
      if (idx > -1) allTasks.splice(idx, 1);
      
      // 順番振り直し
      const remainingTasks = allTasks.filter(t => t['タスク名'] === taskName).sort((a,b)=>(a['順番']||0)-(b['順番']||0));
      remainingTasks.forEach((t, i) => t['順番'] = i + 1);
      
      saveTasks();
      renderAll();
    }

    function deleteTaskGroup(taskName) {
      if (!confirm(`タスク「${taskName}」と全てのステップを削除しますか？`)) return;
      allTasks = allTasks.filter(t => t['タスク名'] !== taskName);
      saveTasks();
      renderAll();
    }

    // --- アイコンモーダル ---
    const iconModal = document.getElementById('iconModal');
    const presetIconGrid = document.getElementById('presetIconGrid');
    
    function initModal() {
      presetIconGrid.innerHTML = '';
      PRESET_ICONS.forEach(icon => {
        const div = document.createElement('div');
        div.className = 'icon-item';
        div.innerHTML = `<i class="${icon}"></i>`;
        div.onclick = () => selectIcon(icon);
        presetIconGrid.appendChild(div);
      });
      
      document.querySelector('.close-modal').onclick = () => iconModal.classList.add('hidden');
      window.onclick = (e) => { if (e.target === iconModal) iconModal.classList.add('hidden'); };
    }

    function openIconModalForTask(taskName) {
      currentEditingTaskName = taskName;
      iconModal.classList.remove('hidden');
    }

    function selectIcon(iconClass) {
      if (currentEditingTaskName) {
        // そのタスク名の全てのステップのアイコンを一括変更
        allTasks.forEach(t => {
          if (t['タスク名'] === currentEditingTaskName) {
            t['アイコン'] = iconClass;
          }
        });
        saveTasks();
        renderAll();
      }
      iconModal.classList.add('hidden');
    }

    // --- 初期化 ---
    document.addEventListener('DOMContentLoaded', () => {
      loadTasks();
      initModal();
    });
  </script>
</body>
</html>